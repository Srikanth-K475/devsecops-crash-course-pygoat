name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:

  # ==========================
  # Python SAST Scan (Bandit)
  # ==========================
  sast_scan:
    name: Run Bandit Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11

    - name: Install Bandit
      run: pip install bandit

    - name: Run Bandit Scan
      run: |
        bandit -ll -ii -r . -f json -o bandit-report.json
        echo "===== Bandit Report ====="
        cat bandit-report.json

    - name: Upload Bandit Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-findings
        path: bandit-report.json

  # ==========================
  # Docker Image Build & Scan
  # ==========================
  image_scan:
    name: Build Docker Image and Run Trivy Scan
    runs-on: ubuntu-latest
    needs: sast_scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: docker build -f Dockerfile -t myapp:latest .

    - name: Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy

    - name: Run Trivy Image Scan
      run: |
        echo "===== Trivy Image Scan ====="
        trivy image --exit-code 1 --severity CRITICAL,HIGH --format table myapp:latest

    - name: Save Trivy JSON Report
      run: trivy image --format json -o trivy-report.json myapp:latest

    - name: Show Trivy Report
      run: cat trivy-report.json
