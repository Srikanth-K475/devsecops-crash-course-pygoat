name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  sast_scan:
    name: Run Bandit Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install Bandit
      run: pip install bandit

    - name: Run Bandit Scan (Readable Output)
      run: |
        echo "===== Bandit Scan Results ====="
        bandit -ll -ii -r . -f text
        echo "===== Bandit JSON Report ====="
        bandit -ll -ii -r . -f json -o bandit-report.json

    - name: Upload Bandit JSON Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-findings
        path: bandit-report.json

    - name: Publish Bandit Summary in GitHub UI
      uses: actions/upload-summary@v2
      if: always()
      run: |
        echo "|Severity|Test|File|Line|" > summary-bandit.md
        echo "|---|---|---|---|" >> summary-bandit.md
        cat bandit-report.json | jq -r '.results[] | "|"+.issue_severity+"|"+.test_name+"|"+.filename+"|"+(.line_number|tostring)+"|" ' >> summary-bandit.md
        cat summary-bandit.md >> $GITHUB_STEP_SUMMARY

  image_scan:
    name: Build Docker Image and Run Trivy Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: docker build -f Dockerfile -t myapp:latest .

    - name: Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.deb
        sudo dpkg -i trivy_Linux-64bit.deb

    - name: Run Trivy Scan (Readable Output)
      run: |
        echo "===== Trivy Image Scan (Critical/High) ====="
        trivy image --severity CRITICAL,HIGH --format table myapp:latest
        echo "===== Trivy JSON Report ====="
        trivy image --severity CRITICAL,HIGH --format json --output trivy-report.json myapp:latest

    - name: Upload Trivy JSON Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-findings
        path: trivy-report.json

    - name: Publish Trivy Summary in GitHub UI
      uses: actions/upload-summary@v2
      if: always()
      run: |
        echo "|Severity|Vulnerability|Package|Version|Fix|" > summary-trivy.md
        echo "|---|---|---|---|---|" >> summary-trivy.md
        cat trivy-report.json | jq -r '.Results[].Vulnerabilities[]? | "|"+.Severity+"|"+.VulnerabilityID+"|"+.PkgName+"|"+.InstalledVersion+"|"+(.FixedVersion//"-")+"|" ' >> summary-trivy.md
        cat summary-trivy.md >> $GITHUB_STEP_SUMMARY
